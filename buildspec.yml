version: 0.2

env:
    variables:
        AWS_ACCOUNT_ID: '239844027862'
        AWS_DEFAULT_REGION: us-east-1
        IMAGE_REPO_NAME: adazza-ci-ecr
        IMAGE_TAG: adazza-central-web
    # parameter-store:
    #   LOGIN_PASSWORD: "dockerLoginPassword"

phases:
    install:
        commands:
            # TODO: here for debug, remove
            - env
            # https://docs.aws.amazon.com/codebuild/latest/userguide/sample-docker-custom-image.html
            - nohup dockerd --host=unix:///var/run/docker.sock --host=tcp://127.0.0.1:2375 --storage-driver=overlay&
            - timeout 15 sh -c "until docker info; do echo .; sleep 1; done"

            - yarn install --frozen-lockfile
    pre_build:
        commands:
            - echo Logging in to Amazon ECR...
            - $(aws ecr get-login --no-include-email --region $AWS_DEFAULT_REGION)
            #         - yarn run lint
            #         - yarn test
    build:
        commands:
            - docker build -t $IMAGE_REPO_NAME:$IMAGE_TAG ./images/adazza-central-web
            - docker tag $IMAGE_REPO_NAME:$IMAGE_TAG $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME:$IMAGE_TAG
    post_build:
        commands:
            - echo Pushing the Docker image...
            - docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME:$IMAGE_TAG
cache:
    paths:
        - 'node_modules/**/*'
        - '~/.cache/yarn'
        - '/var/lib/docker'
